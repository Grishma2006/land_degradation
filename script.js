// ---- Translations (en, hi, mr) ----
const I18N = {
  en: {
    nav_home:"Home", nav_soil:"Soil", nav_causes:"Causes", nav_prev:"Prevention", nav_help:"Help",
    home_title:"Healthy Soil. Better Yields.",
    home_intro:"Tap an option below. Simple language, pictures, and audio help included.",
    home_card_soil:"Check Soil", home_card_soil_desc:"Choose soil condition → get solution + audio.",
    home_card_causes:"Causes", home_card_causes_desc:"See what harms soil and quick fixes.",
    home_card_prev:"Prevention", home_card_prev_desc:"Easy steps to keep soil healthy.",
    home_card_help:"Help & Audio", home_card_help_desc:"How to use this site with voice.",
    soil_title:"Select your soil condition", soil_dry:"Dry", soil_cracked:"Cracked", soil_sandy:"Sandy", soil_wet:"Wet/Waterlogged",
    sol_title:"Solution", btn_listen:"Listen", btn_copy:"Copy", btn_print:"Print", btn_reset:"Reset",
    causes_title:"What harms the soil?",
    cause_deforest:"Deforestation", cause_deforest_desc:"Trees removed → soil erodes.",
    cause_grazing:"Overgrazing", cause_grazing_desc:"Too many animals → no grass cover.",
    cause_chem:"Excess chemicals", cause_chem_desc:"Kills soil life, makes it salty.",
    cause_poll:"Pollution & waste", cause_poll_desc:"Dirty water/garbage harms fields.",
    prev_title:"Simple prevention steps",
    prev_trees:"Plant trees/grass", prev_trees_desc:"Roots hold soil. Plant on borders.",
    prev_water:"Smart irrigation", prev_water_desc:"Use drip/sprinkler; mulch saves water.",
    prev_organic:"Organic matter", prev_organic_desc:"Compost + manure feed soil life.",
    prev_rotation:"Crop rotation", prev_rotation_desc:"Rotate crops; add legumes.",
    help_title:"How to use",
    help_s1:"Choose language at top.",
    help_s2:"Tap a picture (Soil/Cause/Prevention).",
    help_s3:"Read the tip or press speaker to listen.",
    help_s4:"Follow simple steps in your field."
  },
  hi: {
    nav_home:"मुखपृष्ठ", nav_soil:"मिट्टी", nav_causes:"कारण", nav_prev:"रोकथाम", nav_help:"सहायता",
    home_title:"स्वस्थ मिट्टी, बेहतर उपज",
    home_intro:"नीचे विकल्प चुनें। सरल भाषा, चित्र और ऑडियो सुविधा उपलब्ध।",
    home_card_soil:"मिट्टी जाँच", home_card_soil_desc:"मिट्टी की स्थिति चुनें → समाधान + ऑडियो।",
    home_card_causes:"कारण", home_card_causes_desc:"मिट्टी को नुकसान और त्वरित उपाय देखें।",
    home_card_prev:"रोकथाम", home_card_prev_desc:"मिट्टी को स्वस्थ रखने के आसान तरीके।",
    home_card_help:"सहायता व ऑडियो", home_card_help_desc:"इस साइट का उपयोग व आवाज़ में सुनें।",
    soil_title:"अपनी मिट्टी की स्थिति चुनें", soil_dry:"सूखी", soil_cracked:"फटी हुई", soil_sandy:"रेतीली", soil_wet:"गीली/जलभराव",
    sol_title:"समाधान", btn_listen:"सुनें", btn_copy:"कॉपी", btn_print:"प्रिंट", btn_reset:"रीसेट",
    causes_title:"मिट्टी को क्या नुकसान पहुँचाता है?",
    cause_deforest:"वनों की कटाई", cause_deforest_desc:"पेड़ हटे → मिट्टी बहती है।",
    cause_grazing:"अत्यधिक चराई", cause_grazing_desc:"बहुत जानवर → घास नहीं बचती।",
    cause_chem:"अत्यधिक रसायन", cause_chem_desc:"मिट्टी का जीवन नष्ट, लवणीयता बढ़ती है।",
    cause_poll:"प्रदूषण व कचरा", cause_poll_desc:"गंदा पानी/कचरा खेतों को नुकसान देता है।",
    prev_title:"सरल रोकथाम के उपाय",
    prev_trees:"पेड़/घास लगाएँ", prev_trees_desc:"जड़ें मिट्टी पकड़े। किनारों पर लगाएँ।",
    prev_water:"स्मार्ट सिंचाई", prev_water_desc:"ड्रिप/स्प्रिंकलर; मल्च से पानी बचेगा।",
    prev_organic:"जैविक पदार्थ", prev_organic_desc:"कम्पोस्ट + गोबर से मिट्टी पोषित।",
    prev_rotation:"फसल चक्र", prev_rotation_desc:"फसलें बदलें; दलहनी फसल जोड़ें।",
    help_title:"कैसे उपयोग करें",
    help_s1:"ऊपर भाषा चुनें।",
    help_s2:"चित्र पर टैप करें (मिट्टी/कारण/रोकथाम)।",
    help_s3:"सलाह पढ़ें या स्पीकर दबाकर सुनें।",
    help_s4:"खेत में सरल कदम अपनाएँ।"
  },
  mr: {
    nav_home:"मुख्यपृष्ठ", nav_soil:"माती", nav_causes:"कारणे", nav_prev:"प्रतिबंध", nav_help:"मदत",
    home_title:"निरोगी माती, चांगले उत्पादन",
    home_intro:"खाली पर्याय निवडा. सोपी भाषा, चित्रे आणि ऑडिओ मदत उपलब्ध.",
    home_card_soil:"माती तपासा", home_card_soil_desc:"मातीची अवस्था निवडा → उपाय + ऑडिओ.",
    home_card_causes:"कारणे", home_card_causes_desc:"मातीला हानी व त्वरित उपाय पाहा.",
    home_card_prev:"प्रतिबंध", home_card_prev_desc:"माती निरोगी ठेवण्यासाठी सोपे उपाय.",
    home_card_help:"मदत व ऑडिओ", home_card_help_desc:"ही साईट कशी वापरायची ते ऐका.",
    soil_title:"तुमची मातीची अवस्था निवडा", soil_dry:"कोरडी", soil_cracked:"भेगा पडलेली", soil_sandy:"वालुकामय", soil_wet:"ओलसर/पाणी साचलेली",
    sol_title:"उपाय", btn_listen:"ऐका", btn_copy:"कॉपी", btn_print:"प्रिंट", btn_reset:"रिसेट",
    causes_title:"मातीला काय अपाय होतो?",
    cause_deforest:"वनतोड", cause_deforest_desc:"झाडे कापली → माती वाहून जाते.",
    cause_grazing:"अतिचराई", cause_grazing_desc:"जास्त जनावरे → गवत राहत नाही.",
    cause_chem:"अतिरिक्त रसायने", cause_chem_desc:"मातीतील जीव नष्ट, क्षार वाढतात.",
    cause_poll:"प्रदूषण व कचरा", cause_poll_desc:"घाण पाणी/कचरा शेतांचे नुकसान.",
    prev_title:"सोपे प्रतिबंधक उपाय",
    prev_trees:"झाडे/गवत लावा", prev_trees_desc:"मुळे माती घट्ट धरतात. कडेवर लावा.",
    prev_water:"आधुनिक सिंचन", prev_water_desc:"ड्रिप/स्प्रिंकलर; मल्चने पाणी बचत.",
    prev_organic:"सेंद्रीय खात", prev_organic_desc:"कंपोस्ट + शेणखत मातीला खाद्य.",
    prev_rotation:"पीक फेरपालट", prev_rotation_desc:"पिके बदलत रहा; कडधान्य जोडा.",
    help_title:"कसे वापरायचे",
    help_s1:"वर भाषा निवडा.",
    help_s2:"चित्रावर टॅप करा (माती/कारणे/प्रतिबंध).",
    help_s3:"सल्ला वाचा किंवा स्पीकरवरून ऐका.",
    help_s4:"शेतात सोपे पाऊल उचला."
  }
};

// ---- Persisted language ----
function getLang(){ return localStorage.getItem('lang') || 'mr'; }
function setLang(lang){
  localStorage.setItem('lang', lang);
  translatePage();
}

// ---- Apply translations to elements with data-i18n ----
function translatePage(){
  const lang = getLang();
  const map = I18N[lang] || I18N.en;
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key = el.getAttribute('data-i18n');
    if(map[key]) el.textContent = map[key];
  });
  const sel = document.getElementById('langSel');
  if(sel) sel.value = lang;
}

// ---- Simple speech synthesis (browser TTS) ----
function speakText(text, lang){
  if(!('speechSynthesis' in window)) { alert('Speech not supported on this device'); return; }
  const utter = new SpeechSynthesisUtterance(text);
  // Try to pick a voice matching language (may vary by device)
  const voiceLang = lang === 'mr' ? 'mr-IN' : lang === 'hi' ? 'hi-IN' : 'en-US';
  const voices = speechSynthesis.getVoices();
  const match = voices.find(v=>v.lang.startsWith(voiceLang)) || voices.find(v=>v.lang.startsWith(voiceLang.split('-')[0])) || voices[0];
  if(match) utter.voice = match;
  utter.lang = match?.lang || voiceLang;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
}

// ---- Soil solutions content (short, farmer-friendly) ----
const SOIL_SOL = {
  dry: {
    en:["Mulch soil to keep water.","Use drip/sprinkler.","Choose drought-tolerant crops."],
    hi:["मल्च डालें ताकि नमी रहे।","ड्रिप/स्प्रिंकलर सिंचाई करें।","सूखा सहनशील फसलें लें।"],
    mr:["मल्च टाका म्हणजे ओलावा राहील.","ड्रिप/स्प्रिंकलर वापरा.","दुष्काळ सहनशील पिके घ्या."]
  },
  cracked: {
    en:["Add compost + manure.","Reduce tillage.","Keep soil covered with straw."],
    hi:["कम्पोस्ट + गोबर मिलाएँ।","जुताई कम करें।","फूस/घास से ढककर रखें।"],
    mr:["कंपोस्ट + शेणखत द्या.","नांगरणी कमी करा.","फुस/गवताने झाकून ठेवा."]
  },
  sandy: {
    en:["Mix compost for holding water.","Frequent light irrigation.","Windbreak trees on borders."],
    hi:["कम्पोस्ट मिलाएँ ताकि पानी ठहरे।","हल्की परन्तु बार-बार सिंचाई।","किनारों पर पेड़ों की रोपाई करें।"],
    mr:["पाणी धरून ठेवण्यासाठी कंपोस्ट मिसळा.","हलक्या पण वारंवार सिंचन करा.","कडेवर वाऱ्यारोधक झाडे लावा."]
  },
  wet: {
    en:["Make drainage channels.","Raised beds for crops.","Avoid over-irrigation."],
    hi:["निकास नालियाँ बनायें।","ऊँची क्यारियाँ बनायें।","अति-सिंचाई न करें।"],
    mr:["पाण्याचा निचरा करा.","पीकासाठी उंच बेड तयार करा.","अति सिंचन टाळा."]
  }
};

// ---- Helpers ----
function currentLang(){ return getLang(); }
function listToSpeech(lines){ return lines.join('. '); }

// ---- Page wiring ----
document.addEventListener('DOMContentLoaded', ()=>{
  // Set language selector & translate
  const sel = document.getElementById('langSel');
  if(sel){
    sel.value = getLang();
    sel.addEventListener('change', e=> setLang(e.target.value));
  }
  translatePage();

  // Soil choices
  document.querySelectorAll('.card-choice').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const soil = btn.getAttribute('data-soil');
      const lang = currentLang();
      const list = SOIL_SOL[soil][lang];
      const box = document.getElementById('solutionBox');
      const ul = document.getElementById('solList');
      ul.innerHTML = '';
      list.forEach(line=>{
        const li = document.createElement('li'); li.textContent = line; ul.appendChild(li);
      });
      box.classList.remove('hidden');

      // Buttons: speak/copy/print/reset
      document.getElementById('speakBtn').onclick = ()=> speakText(listToSpeech(list), lang);
      document.getElementById('copyBtn').onclick = async ()=>{
        await navigator.clipboard.writeText(list.join('\n')); alert('Copied!');
      };
      document.getElementById('printBtn').onclick = ()=> window.print();
      document.getElementById('resetBtn').onclick = ()=>{
        ul.innerHTML=''; box.classList.add('hidden');
      };
    });
  });

  // Generic "speak" buttons on cards
  document.querySelectorAll('.speak').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const lang = currentLang();
      // Get nearby text (title + desc)
      const card = btn.closest('.card');
      const text = Array.from(card.querySelectorAll('h3,p')).map(n=>n.textContent.trim()).join('. ');
      speakText(text, lang);
    });
  });

  // Help page "play"
  const playHelp = document.getElementById('playHelp');
  if(playHelp){
    playHelp.addEventListener('click', ()=>{
      const lang = currentLang();
      const lines = ['help_s1','help_s2','help_s3','help_s4'].map(k=>I18N[lang][k]);
      speakText(lines.join('. '), lang);
    });
  }
});
